#!/bin/bash
# simple creation of aws-vault profile

# src: limed

set -eu

color_ok()(set -o pipefail;"$@" 2>&1>&3|sed $'s,.*,\e[0;32m&\e[m,'>&2)3>&1

echo_bad () {
    echo -e "\033[0;31m$@\033[0m"
}

echo_ok () {
    echo -e "\033[0;32m$@\033[0m"
}

# Check requirements
hash aws-vault 2>/dev/null || echo_bad "Requires aws-vault to be installed. https://github.com/99designs/aws-vault"
hash jq  2>/dev/null || echo_bad "Requires jq to be installed. https://github.com/stedolan/jq"
hash aws 2>/dev/null || echo_bad "Requires awscli to be installed. https://aws.amazon.com/cli/"

echo -n "AWS Access Key ID: "
read -r AWS_ACCESS_KEY_ID
if [[ -z "${AWS_ACCESS_KEY_ID}" ]]; then
    echo_bad "[Error] AWS Access Key ID is not set"
    exit 1
fi

echo -n "AWS Secret Access Key: "
read -r AWS_SECRET_ACCESS_KEY
if [[ -z "${AWS_SECRET_ACCESS_KEY}" ]]; then
    echo_bad "[Error] AWS Secret access key is not set"
    exit 1
fi

echo -n "AWS Account name: "
read -r ACCOUNT_NAME
if [[ -z "${ACCOUNT_NAME}" ]]; then
    echo_bad "[Error] AWS Profile is not set"
    exit 1
fi

echo -n "LDAP UID (not your email address): "
read -r LOGIN
if [[ -z "${LOGIN}" ]]; then
    echo_bad "[Error] Login UID is not set"
    exit 1
fi

export AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY

echo_ok "Adding ${ACCOUNT_NAME} to aws-vault"
color_ok aws-vault add --env "${ACCOUNT_NAME}"
RV=$?
if [[ ${RV} -ne 0 ]]; then
    echo_bad "[Error] ${ACCOUNT_NAME} could not be added to aws-vault"
    exit 1
fi

echo_ok "Creating virtual mfa device"
VIRTUAL_MFA_ARN=$(color_ok aws-vault exec -n "${ACCOUNT_NAME}" -- aws iam create-virtual-mfa-device --virtual-mfa-device-name "${LOGIN}" --outfile "${LOGIN}".png --bootstrap-method QRCodePNG | jq .VirtualMFADevice.SerialNumber -r)
if [[ -z "${VIRTUAL_MFA_ARN}" ]]; then
    echo_bad "[Error] Virual MFA ARN already exists"
    exit 1
fi
