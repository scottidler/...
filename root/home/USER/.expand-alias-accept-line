#!/bin/zsh

. ~/.shell-aliases

lookup() {
    if [[ "$1" == "-g" ]]; then
        OPT="$1"; shift
    fi
    if [[ "$1" != "-"* ]]; then
        EXP=$(alias "$OPT" "$1" | sed -re 's/([^=]+)=(.*)/\2/' | sed -re "s/^'(.*)'$/\1/")
        if [[ -n "$EXP" ]]; then
            echo "$EXP"
            return
        fi
    fi
    echo "$1"
}

expand-alias-accept-line() {
    if [ -n "$DEBUG" ]; then
        PS4=':${LINENO}+'
        set -x
    fi
    if [[ -n "$EXPAND_ALIASES" ]] && [[ "$BUFFER" != "alias"* ]] && [[ "$BUFFER" != "#"* ]]; then
        TOKENS=("${(@s/ /)BUFFER}")
        BUFFER=""
        CMD="${TOKENS[1]}"
        BUFFER="$(lookup "$CMD")"
        ARGS=($(echo "${TOKENS[2,-1]}"))
        for ARG in $ARGS; do
            BUFFER+=" $(lookup -g "$ARG")"
        done
        if [[ "$BUFFER" == *" !" ]]; then
            BUFFER="sudo ${BUFFER% !}"
        fi
    fi
    zle .accept-line
}

zle -N accept-line expand-alias-accept-line
