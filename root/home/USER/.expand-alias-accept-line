#!/bin/zsh

. ~/.shell-aliases

lookup() {
    if [ -n "$DEBUG_LOOKUP" ]; then
        PS4=':${LINENO}+'
        set -x
    fi
    if [[ "$1" == "-g" ]]; then
        OPT="$1"; shift
    fi
    if [[ "$1" != "-"* ]]; then
        EXP=$(alias "$OPT" "$1" | sed -re 's/([^=]+)=(.*)/\2/' | sed -re "s/^'(.*)'$/\1/")
        if [[ -n "$EXP" ]]; then
            echo "$EXP"
            return
        fi
    fi
    printf '%s\n' "$1"
}

expand-alias-accept-line() {
    if [ -n "$DEBUG_EXPAND" ]; then
        PS4=':${LINENO}+'
        set -x
    fi
    if [[ -n "$BUFFER" ]] && [[ -n "$EXPAND_ALIASES" ]] && [[ "$BUFFER" != "alias"* ]] && [[ "$BUFFER" != "#"* ]]; then
        TOKENS=("${(@s/ /)BUFFER}")
        NEW_BUFFER=""
        CMD="${TOKENS[1]}"
        NEW_BUFFER="$(lookup "$CMD")"
        ARGS=($(echo "${TOKENS[2,-1]}"))
        for ARG in $ARGS; do
            NEW_BUFFER+=" $(lookup -g "$ARG")"
        done
        if [[ "$NEW_BUFFER" == *" !" ]]; then
            NEW_BUFFER="sudo ${NEW_BUFFER% !}"
        fi
    fi
    if [ -n "$DEBUG_EXPAND" ]; then
        echo "$BUFFER -> $NEW_BUFFER"
    fi
    BUFFER="$NEW_BUFFER"
    zle .accept-line
}

zle -N accept-line expand-alias-accept-line
